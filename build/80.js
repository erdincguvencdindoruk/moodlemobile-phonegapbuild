webpackJsonp([80],{2091:function(n,i,t){"use strict";function e(n){return o._42(0,[(n()(),o._16(0,0,null,null,13,"ion-item",[["class","item-title item item-block"],["text-wrap",""]],null,null,null,V.b,V.a)),o._15(1,1097728,null,3,K.a,[W.a,A.a,o.p,o.K,[2,N.a]],null,null),o._37(335544320,2,{contentLabel:0}),o._37(603979776,3,{_buttons:1}),o._37(603979776,4,{_icons:1}),o._15(5,16384,null,0,B.a,[],null,null),(n()(),o._40(-1,2,["\n                "])),(n()(),o._16(7,0,null,3,5,"ion-input",[["name","title"],["type","text"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],null,null,R.b,R.a)),o._15(8,671744,null,0,d.f,[[3,d.b],[8,null],[8,null],[8,null]],{name:[0,"name"]},null),o._35(2048,null,d.m,null,[d.f]),o._15(10,16384,null,0,d.n,[d.m],null,null),o._15(11,5423104,null,0,H.a,[A.a,j.a,W.a,$.a,o.p,o.K,[2,G.a],[2,K.a],[2,d.m],J.a],{type:[0,"type"],placeholder:[1,"placeholder"]},null),o._32(131072,q.a,[z.a,o.i]),(n()(),o._40(-1,2,["\n            "]))],function(n,i){n(i,8,0,"title");n(i,11,0,"text",o._41(i,11,1,o._29(i,12).transform("addon.mod_wiki.newpagetitle")))},function(n,i){n(i,7,0,o._29(i,10).ngClassUntouched,o._29(i,10).ngClassTouched,o._29(i,10).ngClassPristine,o._29(i,10).ngClassDirty,o._29(i,10).ngClassValid,o._29(i,10).ngClassInvalid,o._29(i,10).ngClassPending)})}function l(n){return o._42(0,[(n()(),o._16(0,0,null,null,11,"ion-item",[["class","addon-mod_wiki-wrongversionlock item item-block"],["text-center",""]],null,null,null,V.b,V.a)),o._15(1,1097728,null,3,K.a,[W.a,A.a,o.p,o.K,[2,N.a]],null,null),o._37(335544320,8,{contentLabel:0}),o._37(603979776,9,{_buttons:1}),o._37(603979776,10,{_icons:1}),o._15(5,16384,null,0,B.a,[],null,null),(n()(),o._40(-1,2,["\n                "])),(n()(),o._16(7,0,null,2,3,"ion-badge",[["color","danger"],["padding",""]],null,null,null,null,null)),o._15(8,16384,null,0,Q.a,[A.a,o.p,o.K],{color:[0,"color"]},null),(n()(),o._40(9,null,["",""])),o._32(131072,q.a,[z.a,o.i]),(n()(),o._40(-1,2,["\n            "]))],function(n,i){n(i,8,0,"danger")},function(n,i){n(i,9,0,o._41(i,9,0,o._29(i,10).transform("addon.mod_wiki.wrongversionlock")))})}function a(n){return o._42(0,[(n()(),o._16(0,0,null,null,23,"ion-header",[],null,null,null,null,null)),o._15(1,16384,null,0,X.a,[A.a,o.p,o.K,[2,Y.a]],null,null),(n()(),o._40(-1,null,["\n    "])),(n()(),o._16(3,0,null,null,19,"ion-navbar",[["class","toolbar"],["core-back-button",""]],[[8,"hidden",0],[2,"statusbar-padding",null]],null,null,Z.b,Z.a)),o._15(4,49152,null,0,nn.a,[$.a,[2,Y.a],[2,tn.a],A.a,o.p,o.K],null,null),o._15(5,212992,null,0,en.a,[nn.a,j.a,z.a,c.a],null,null),(n()(),o._40(-1,3,["\n        "])),(n()(),o._16(7,0,null,3,3,"ion-title",[],null,null,null,ln.b,ln.a)),o._15(8,49152,null,0,an.a,[A.a,o.p,o.K,[2,on.a],[2,nn.a]],null,null),(n()(),o._16(9,0,null,0,1,"core-format-text",[],null,null,null,null,null)),o._15(10,540672,null,0,un.a,[o.p,g.a,_.a,p.a,z.a,j.a,rn.a,sn.a,dn.a,cn.a,gn.a,hn.a,[2,tn.a],[2,G.a],[2,_n.a],pn.a,c.a],{text:[0,"text"]},null),(n()(),o._40(-1,3,["\n\n        "])),(n()(),o._16(12,0,null,2,9,"ion-buttons",[["end",""]],null,null,null,null,null)),o._15(13,16384,null,1,fn.a,[A.a,o.p,o.K,[2,on.a],[2,nn.a]],null,null),o._37(603979776,1,{_buttons:1}),(n()(),o._40(-1,null,["\n            "])),(n()(),o._16(16,0,null,null,4,"button",[["clear",""],["ion-button",""]],[[1,"aria-label",0]],[[null,"click"]],function(n,i,t){var e=!0;if("click"===i){e=!1!==n.component.save()&&e}return e},In.b,In.a)),o._15(17,1097728,[[1,4]],0,kn.a,[[8,""],A.a,o.p,o.K],{clear:[0,"clear"]},null),o._32(131072,q.a,[z.a,o.i]),(n()(),o._40(19,0,["\n                ","\n            "])),o._32(131072,q.a,[z.a,o.i]),(n()(),o._40(-1,null,["\n        "])),(n()(),o._40(-1,3,["\n    "])),(n()(),o._40(-1,null,["\n"])),(n()(),o._40(-1,null,["\n"])),(n()(),o._16(25,0,null,null,31,"ion-content",[],[[2,"statusbar-padding",null],[2,"has-refresher",null]],null,null,wn.b,wn.a)),o._15(26,4374528,null,0,G.a,[A.a,j.a,J.a,o.p,o.K,$.a,mn.a,o.D,[2,Y.a],[2,tn.a]],null,null),(n()(),o._40(-1,1,["\n    "])),(n()(),o._16(28,0,null,1,27,"core-loading",[],null,null,null,vn.b,vn.a)),o._15(29,638976,null,0,bn.a,[z.a,o.p,c.a,rn.a],{hideUntil:[0,"hideUntil"]},null),(n()(),o._40(-1,0,["\n        "])),(n()(),o._16(31,0,null,0,23,"form",[["ion-list",""],["novalidate",""]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"submit"],[null,"reset"]],function(n,i,t){var e=!0;if("submit"===i){e=!1!==o._29(n,33).onSubmit(t)&&e}if("reset"===i){e=!1!==o._29(n,33).onReset()&&e}return e},null,null)),o._15(32,16384,null,0,d.w,[],null,null),o._15(33,540672,null,0,d.h,[[8,null],[8,null]],{form:[0,"form"]},null),o._35(2048,null,d.b,null,[d.h]),o._15(35,16384,null,0,d.o,[d.b],null,null),(n()(),o._40(-1,null,["\n            "])),(n()(),o._11(16777216,null,null,1,null,e)),o._15(38,16384,null,0,Pn.k,[o.W,o.T],{ngIf:[0,"ngIf"]},null),(n()(),o._40(-1,null,["\n\n            "])),(n()(),o._16(40,0,null,null,10,"ion-item",[["class","item item-block"]],null,null,null,V.b,V.a)),o._15(41,1097728,null,3,K.a,[W.a,A.a,o.p,o.K,[2,N.a]],null,null),o._37(335544320,5,{contentLabel:0}),o._37(603979776,6,{_buttons:1}),o._37(603979776,7,{_icons:1}),o._15(45,16384,null,0,B.a,[],null,null),(n()(),o._40(-1,2,["\n                "])),(n()(),o._16(47,0,null,3,2,"core-rich-text-editor",[["item-content",""],["name","wiki_page_content"]],null,null,null,yn.b,yn.a)),o._15(48,1228800,null,0,Cn.a,[_.a,sn.a,g.a,cn.a,[2,G.a],o.p,c.a,rn.a,j.a],{placeholder:[0,"placeholder"],control:[1,"control"],name:[2,"name"],component:[3,"component"],componentId:[4,"componentId"]},null),o._32(131072,q.a,[z.a,o.i]),(n()(),o._40(-1,2,["\n            "])),(n()(),o._40(-1,null,["\n\n            "])),(n()(),o._11(16777216,null,null,1,null,l)),o._15(53,16384,null,0,Pn.k,[o.W,o.T],{ngIf:[0,"ngIf"]},null),(n()(),o._40(-1,null,["\n        "])),(n()(),o._40(-1,0,["\n    "])),(n()(),o._40(-1,1,["\n"])),(n()(),o._40(-1,null,["\n"]))],function(n,i){var t=i.component;n(i,5,0);n(i,10,0,t.title);n(i,17,0,"");n(i,29,0,t.loaded);n(i,33,0,t.pageForm);n(i,38,0,t.canEditTitle);n(i,48,0,o._41(i,48,0,o._29(i,49).transform("core.content")),t.contentControl,"wiki_page_content",t.component,t.componentId);n(i,53,0,t.wrongVersionLock)},function(n,i){n(i,3,0,o._29(i,4)._hidden,o._29(i,4)._sbPadding);n(i,16,0,o._41(i,16,0,o._29(i,18).transform("core.save")));n(i,19,0,o._41(i,19,0,o._29(i,20).transform("core.save")));n(i,25,0,o._29(i,26).statusbarPadding,o._29(i,26)._hasRefresher);n(i,31,0,o._29(i,35).ngClassUntouched,o._29(i,35).ngClassTouched,o._29(i,35).ngClassPristine,o._29(i,35).ngClassDirty,o._29(i,35).ngClassValid,o._29(i,35).ngClassInvalid,o._29(i,35).ngClassPending)})}Object.defineProperty(i,"__esModule",{value:!0});var o=t(1),u=(t(0),t(7),t(4)),r=t(30),s=t(32),d=t(23),c=t(12),g=t(2),h=t(76),_=t(5),p=t(11),f=t(15),I=t(37),k=t(230),w=t(284),m=t(285),v=function(){function n(n,i,t,e,l,a,o,u,r,s,d,c,g,h){this.navCtrl=t,this.sitesProvider=e,this.syncProvider=l,this.domUtils=a,this.translate=o,this.courseProvider=u,this.eventsProvider=r,this.wikiProvider=s,this.wikiOffline=d,this.wikiSync=c,this.textUtils=g,this.courseHelper=h,this.component=k.a.COMPONENT,this.forceLeave=!1,this.isDestroyed=!1,this.module=n.get("module")||{},this.courseId=n.get("courseId"),this.subwikiId=n.get("subwikiId"),this.wikiId=n.get("wikiId"),this.pageId=n.get("pageId"),this.section=n.get("section"),this.groupId=n.get("groupId"),this.userId=n.get("userId");var _=n.get("pageTitle");_=_?_.replace(/\+/g," "):"",this.initialSubwikiId=this.subwikiId,this.componentId=this.module.id,this.canEditTitle=!_,this.title=_?this.translate.instant("addon.mod_wiki.editingpage",{$a:_}):this.translate.instant("addon.mod_wiki.newpagehdr"),this.blockId=this.wikiSync.getSubwikiBlockId(this.subwikiId,this.wikiId,this.userId,this.groupId),this.contentControl=i.control(""),this.pageForm=i.group({title:_}),this.pageForm.addControl("text",this.contentControl),this.syncProvider.blockOperation(this.component,this.blockId)}return n.prototype.ngOnInit=function(){var n=this;this.fetchWikiPageData().then(function(i){if(i&&n.blockId&&!n.isDestroyed){var t=n.wikiSync.getSubwikiBlockId(n.subwikiId,n.wikiId,n.userId,n.groupId);t!=n.blockId&&(n.syncProvider.unblockOperation(n.component,n.blockId),n.blockId=t,n.syncProvider.blockOperation(n.component,n.blockId))}}).finally(function(){n.loaded=!0})},n.prototype.fetchWikiPageData=function(){var n,i=this,t=!1;if(this.pageId)this.canEditTitle=!1,this.editing=!0,this.editOffline=!1,n=this.wikiProvider.getPageContents(this.pageId).then(function(n){return i.pageForm.controls.title.setValue(n.title),i.wikiId=n.wikiid,i.subwikiId=n.subwikiid,i.title=i.translate.instant("addon.mod_wiki.editingpage",{$a:n.title}),i.groupId=n.groupid,i.userId=n.userid,t=n.caneditpage,i.wikiSync.waitForSync(i.blockId)}).then(function(){return i.wikiProvider.getSubwikiFiles(i.wikiId,i.groupId,i.userId)}).then(function(n){return i.subwikiFiles=n,i.wikiProvider.getPageForEditing(i.pageId,i.section)}).then(function(n){var e=i.textUtils.replacePluginfileUrls(n.content,i.subwikiFiles);i.contentControl.setValue(e),i.originalContent=e,i.version=n.version,t&&(i.renewLockInterval=setInterval(function(){i.renewLock()},k.a.RENEW_LOCK_TIME))});else{var e=this.pageForm.controls.title.value;n=this.wikiSync.waitForSync(this.blockId),e?n=n.then(function(n){if(n){var t=n.created.find(function(n){return n.title==e});if(t&&t.pageId>0)return i.pageId=t.pageId,i.fetchWikiPageData()}return i.wikiOffline.getNewPage(e,i.subwikiId,i.wikiId,i.userId,i.groupId)}).then(function(n){i.contentControl.setValue(n.cachedcontent),i.originalContent=n.cachedcontent,i.editOffline=!0}).catch(function(){i.editOffline=!1}):this.editOffline=!1,n.then(function(){i.editing=!1,t=!!i.blockId})}return n.then(function(){return!0}).catch(function(n){return i.domUtils.showErrorModalDefault(n,"Error getting wiki data."),i.forceLeavePage(),!1}).finally(function(){t||(i.domUtils.showAlert(i.translate.instant("core.notice"),i.translate.instant("addon.mod_wiki.cannoteditpage")),i.forceLeavePage())})},n.prototype.forceLeavePage=function(){this.forceLeave=!0,this.navCtrl.pop()},n.prototype.goToNewOfflinePage=function(n){this.courseId&&(this.module.id||this.wikiId)?this.editOffline&&!this.previousViewPageIsDifferentOffline(n)||(this.pageParamsToLoad={module:this.module,courseId:this.courseId,pageId:null,pageTitle:n,wikiId:this.wikiId,subwikiId:this.subwikiId,userId:this.userId,groupId:this.groupId}):this.domUtils.showAlert(this.translate.instant("core.success"),this.translate.instant("core.datastoredoffline")),this.forceLeavePage()},n.prototype.gotoPage=function(n){var i=this;return this.retrieveModuleInfo(this.wikiId).then(function(){var t=!1;i.initialSubwikiId&&(!i.editing&&i.editOffline&&i.previousViewPageIsDifferentOffline(n)?t=!0:!i.editOffline&&i.previousViewIsDifferentPageOnline()&&(t=!0)),t&&(i.pageParamsToLoad={module:i.module,courseId:i.courseId,pageId:i.pageId,pageTitle:n,wikiId:i.wikiId,subwikiId:i.subwikiId,userId:i.userId,groupId:i.groupId}),i.forceLeavePage()}).catch(function(){i.forceLeavePage()})},n.prototype.hasDataChanged=function(){var n=this.pageForm.value;return!(this.originalContent==n.text||!this.editing&&!n.text&&!n.title)},n.prototype.ionViewCanLeave=function(){return!!this.forceLeave||(!this.hasDataChanged()||this.domUtils.showConfirm(this.translate.instant("core.confirmcanceledit")))},n.prototype.ionViewDidLeave=function(){this.pageParamsToLoad&&this.navCtrl.push("AddonModWikiIndexPage",this.pageParamsToLoad)},n.prototype.previousViewIsDifferentPageOnline=function(){var n=this.navCtrl.getPrevious();return!this.editing||"AddonModWikiIndexPage"!=n.component.name||n.data.module.id!=this.module.id||n.data.pageId!=this.pageId},n.prototype.previousViewPageIsDifferentOffline=function(n){var i=this.navCtrl.getPrevious();if("AddonModWikiIndexPage"!=i.component.name||i.data.module.id!=this.module.id||i.data.wikiId!=this.wikiId||i.data.pageTitle!=n)return!0;var t=parseInt(i.data.subwikiId,10)||0;if(t>0&&this.subwikiId>0)return t!=this.subwikiId;var e=parseInt(i.data.userId,10)||0,l=parseInt(i.data.groupId,10)||0;return this.userId!=e||this.groupId!=l},n.prototype.save=function(){var n,i=this,t=this.pageForm.value,e=t.title,l=this.domUtils.showModalLoading("core.sending",!0),a=t.text;if(a=this.textUtils.restorePluginfileUrls(a,this.subwikiFiles),a=this.textUtils.formatHtmlLines(a),this.editing)n=this.wikiProvider.editPage(this.pageId,a,this.section).then(function(){return i.wikiProvider.invalidatePage(i.pageId).then(function(){return i.gotoPage(e)})});else{if(!e)return this.domUtils.showAlert(this.translate.instant("core.notice"),this.translate.instant("addon.mod_wiki.titleshouldnotbeempty")),void l.dismiss();n=(n=this.editOffline?Promise.resolve():this.wikiOffline.getNewPage(e,this.subwikiId,this.wikiId,this.userId,this.groupId).then(function(){return Promise.reject(i.translate.instant("addon.mod_wiki.pageexists"))},function(){})).then(function(){var n=i.wikiId||i.module&&i.module.instance;return i.wikiProvider.newPage(e,a,i.subwikiId,n,i.userId,i.groupId).then(function(t){if(t>0)return i.pageId=t,i.wikiProvider.getPageContents(i.pageId).then(function(t){var l=[];return n=parseInt(t.wikiid,10),i.subwikiId||l.push(i.wikiProvider.invalidateSubwikis(n)),i.subwikiId=parseInt(t.subwikiid,10),i.userId=parseInt(t.userid,10),i.groupId=parseInt(t.groupid,10),l.push(i.wikiProvider.invalidateSubwikiPages(n)),Promise.all(l).then(function(){return i.gotoPage(e)})}).finally(function(){i.eventsProvider.trigger(k.a.PAGE_CREATED_EVENT,{pageId:i.pageId,subwikiId:i.subwikiId,pageTitle:e},i.sitesProvider.getCurrentSiteId())});i.goToNewOfflinePage(e)})})}return n.catch(function(n){i.domUtils.showErrorModalDefault(n,"Error saving wiki data.")}).finally(function(){l.dismiss()})},n.prototype.renewLock=function(){var n=this;this.wikiProvider.getPageForEditing(this.pageId,this.section,!0).then(function(i){i.version&&n.version!=i.version&&(n.wrongVersionLock=!0)})},n.prototype.retrieveModuleInfo=function(n){var i=this;if(this.module.id&&this.courseId)return Promise.resolve();return(this.module.id?Promise.resolve(this.module):this.courseProvider.getModuleBasicInfoByInstance(n,"wiki")).then(function(t){if(i.module=t,i.componentId=i.module.id,!i.courseId&&i.module.course)i.courseId=i.module.course;else if(!i.courseId)return i.courseHelper.getModuleCourseIdByInstance(n,"wiki").then(function(n){i.courseId=n})})},n.prototype.ngOnDestroy=function(){this.isDestroyed=!0,clearInterval(this.renewLockInterval),this.blockId&&this.syncProvider.unblockOperation(this.component,this.blockId)},n}(),b=function(){return function(){}}(),P=t(1471),y=t(1472),C=t(1473),O=t(1474),L=t(1475),x=t(1476),T=t(1477),D=t(1478),E=t(1479),U=t(1480),F=t(1481),S=t(1482),M=t(1483),V=t(31),K=t(22),W=t(21),A=t(8),N=t(29),B=t(33),R=t(105),H=t(85),j=t(17),$=t(35),G=t(27),J=t(34),q=t(28),z=t(19),Q=t(143),X=t(365),Y=t(39),Z=t(713),nn=t(209),tn=t(20),en=t(471),ln=t(714),an=t(307),on=t(245),un=t(42),rn=t(3),sn=t(24),dn=t(6),cn=t(18),gn=t(10),hn=t(14),_n=t(26),pn=t(38),fn=t(366),In=t(45),kn=t(43),wn=t(179),mn=t(102),vn=t(51),bn=t(48),Pn=t(9),yn=t(308),Cn=t(247),On=t(72),Ln=o._14({encapsulation:2,styles:[],data:{}}),xn=o._12("page-addon-mod-wiki-edit",v,function(n){return o._42(0,[(n()(),o._16(0,0,null,null,1,"page-addon-mod-wiki-edit",[],null,null,null,a,Ln)),o._15(1,245760,null,0,v,[On.a,d.d,tn.a,g.a,h.a,_.a,z.a,f.a,c.a,k.a,w.a,m.a,p.a,I.a],null,null)],function(n,i){n(i,1,0)},null)},{},{},[]),Tn=t(361),Dn=t(362),En=t(364),Un=t(363),Fn=t(470),Sn=t(712),Mn=t(110),Vn=t(268);t.d(i,"AddonModWikiEditPageModuleNgFactory",function(){return Kn});var Kn=o._13(b,[],function(n){return o._25([o._26(512,o.n,o._6,[[8,[P.a,y.a,C.a,O.a,L.a,x.a,T.a,D.a,E.a,U.a,F.a,S.a,M.a,xn]],[3,o.n],o.B]),o._26(4608,Pn.m,Pn.l,[o.x,[2,Pn.w]]),o._26(4608,d.x,d.x,[]),o._26(4608,d.d,d.d,[]),o._26(4608,Tn.b,Tn.a,[]),o._26(4608,Dn.a,Dn.b,[]),o._26(4608,En.b,En.a,[]),o._26(4608,Un.b,Un.a,[]),o._26(4608,z.a,z.a,[Fn.a,Tn.b,Dn.a,En.b,Un.b,z.b,z.c]),o._26(512,Pn.b,Pn.b,[]),o._26(512,d.v,d.v,[]),o._26(512,d.i,d.i,[]),o._26(512,d.s,d.s,[]),o._26(512,Sn.a,Sn.a,[]),o._26(512,u.a,u.a,[]),o._26(512,s.a,s.a,[]),o._26(512,Mn.a,Mn.a,[]),o._26(512,r.a,r.a,[]),o._26(512,Sn.b,Sn.b,[]),o._26(512,b,b,[]),o._26(256,z.c,void 0,[]),o._26(256,z.b,void 0,[]),o._26(256,Vn.a,v,[])])})}});